<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Legal Doc Explainer ‚öñÔ∏è</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@11.9.0/build/highlight.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@11.9.0/build/styles/atom-one-dark.min.css">
    <style>
        :root {
            --bg-color: #121212; --primary-color: #1e1e1e; --secondary-color: #2e2e2e;
            --text-color: #e0e0e0; --accent-color: #00aaff; --border-color: #333;
        }
        body {
            font-family: 'Inter', sans-serif; margin: 0; background-color: var(--bg-color);
            color: var(--text-color); display: flex; height: 100vh; overflow: hidden;
        }
        #app-container { display: flex; flex-direction: column; width: 100%; height: 100%; }
        #top-panel {
            flex-shrink: 0; border-bottom: 1px solid var(--border-color);
            display: flex; flex-direction: column; align-items: center; padding: 15px;
            background-color: var(--primary-color);
        }
        #upload-form { display: flex; align-items: center; gap: 10px; }
        #status { font-size: 0.9em; color: #aaa; margin-top: 8px; height: 1.2em;}
        #analysis-container {
            flex-grow: 1; overflow-y: auto; padding: 25px;
            background-color: var(--bg-color);
        }
        #analysis-container h3 { color: var(--accent-color); border-bottom: 1px solid var(--border-color); padding-bottom: 5px; margin-top: 20px;}
        #analysis-container ul { list-style-position: inside; padding-left: 0; }
        #analysis-container li { margin-bottom: 10px; }
        #analysis-container blockquote { border-left: 3px solid var(--accent-color); padding-left: 15px; margin-left: 0; color: #ccc; }
        #chat-container { flex-grow: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; }
        .message { max-width: 80%; margin-bottom: 20px; display: flex; align-items: flex-start; }
        .message.user { align-self: flex-end; flex-direction: row-reverse; }
        .message.bot { align-self: flex-start; }
        .avatar {
            width: 40px; height: 40px; border-radius: 50%; background-color: var(--secondary-color);
            display: flex; align-items: center; justify-content: center; font-weight: bold;
            flex-shrink: 0;
        }
        .user .avatar { margin-left: 10px; background-color: var(--accent-color); }
        .bot .avatar { margin-right: 10px; background-image: url('https://raw.githubusercontent.com/langchain-ai/langchain/master/libs/langchain/langchain/static/langchain_icon_blue.svg'); background-size: 60%; background-position: center; background-repeat: no-repeat;}
        .message-content {
            padding: 12px 18px; border-radius: 18px; background-color: var(--primary-color);
            word-wrap: break-word; overflow-wrap: break-word;
        }
        .message-content p { margin: 0 0 10px; }
        .message-content ul, .message-content ol { padding-left: 20px; margin: 10px 0; }
        .message-content pre { background-color: #282c34; border-radius: 8px; padding: 16px; margin: 10px 0; overflow-x: auto; }
        #main-content { display: flex; flex-grow: 1; overflow: hidden; }
        #left-pane { flex: 1; display: flex; flex-direction: column; border-right: 1px solid var(--border-color); min-width: 250px; }
        #right-pane { flex: 3; display: flex; flex-direction: column; }
        .pane-header { padding: 15px; text-align: center; font-weight: 600; border-bottom: 1px solid var(--border-color); flex-shrink: 0; background-color: var(--secondary-color); }
        #chat-form-container { padding: 20px; border-top: 1px solid var(--border-color); flex-shrink: 0; background-color: var(--primary-color);}
        #chat-form { display: flex; }
        #chat-input {
            flex-grow: 1; padding: 12px; border: 1px solid var(--border-color); border-radius: 8px;
            background-color: var(--secondary-color); color: var(--text-color); font-size: 1em;
        }
        #chat-input:focus { outline: none; border-color: var(--accent-color); }
        #chat-form button {
            margin-left: 10px; padding: 0 20px; border: none; background-color: var(--accent-color);
            color: white; border-radius: 8px; cursor: pointer; font-size: 1.2em;
        }
        #chat-form button:disabled { background-color: var(--secondary-color); cursor: not-allowed; }
        
        /* CORRECTED RESPONSIVE CSS FOR MOBILE */
        @media (max-width: 800px) {
            #main-content {
                flex-direction: column; /* Stack panes vertically */
            }
            #left-pane {
                /* For a column layout, 'flex' controls height distribution. */
                /* Take up 40% of the available height, but don't grow. */
                flex: 0 1 40%;
                border-right: none;
                border-bottom: 1px solid var(--border-color);
                min-height: 150px; /* Ensure pane is not too small */
            }
            #right-pane {
                /* Take up the remaining 60% of the height and allow growing/shrinking. */
                flex: 1 1 60%;
                min-height: 250px; /* Ensure chat has enough space */
            }
        }
    </style>
</head>
<body>
    <div id="app-container">
        <div id="top-panel">
            <h2>AI Legal Doc Explainer</h2>
            <form id="upload-form" enctype="multipart/form-data"><input type="file" name="pdf_file" id="pdf-input" accept=".pdf" required><button type="submit" id="upload-button">Analyze Document</button></form>
            <div id="status">Please upload a legal document (PDF) to begin.</div>
        </div>
        <div id="main-content">
            <div id="left-pane">
                <div class="pane-header">Document Analysis</div>
                <div id="analysis-container"><p style="color: #aaa; text-align: center; padding-top: 20px;">Your document analysis will appear here...</p></div>
            </div>
            <div id="right-pane">
                 <div class="pane-header">Ask Follow-up Questions</div>
                <div id="chat-container"></div>
                <div id="chat-form-container">
                    <form id="chat-form"><input type="text" id="chat-input" placeholder="Ask a specific question..." autocomplete="off" disabled><button type="submit" id="send-button" disabled>‚û§</button></form>
                </div>
            </div>
        </div>
    </div>
    <script>
        const uploadForm = document.getElementById('upload-form'),uploadButton = document.getElementById('upload-button'),chatForm = document.getElementById('chat-form'),chatInput = document.getElementById('chat-input'),sendButton = document.getElementById('send-button'),chatContainer = document.getElementById('chat-container'),statusDiv = document.getElementById('status'),pdfInput = document.getElementById('pdf-input'),analysisContainer = document.getElementById('analysis-container');
        uploadForm.addEventListener('submit', async e => {
            e.preventDefault();
            if (!pdfInput.files[0]) { statusDiv.textContent = 'Please select a file first.'; return; }
            statusDiv.textContent = '‚è≥ Analyzing document... This may take a moment.';
            analysisContainer.innerHTML = '<p style="text-align: center;">Processing...</p>';
            chatContainer.innerHTML = '';
            uploadButton.disabled = true; chatInput.disabled = true; sendButton.disabled = true;
            const formData = new FormData(uploadForm);
            try {
                const response = await fetch('/upload', { method: 'POST', body: formData });
                const result = await response.json();
                if (!response.ok) throw new Error(result.error || 'Unknown server error.');
                statusDiv.textContent = `‚úÖ Analysis complete for "${pdfInput.files[0].name}"`;
                analysisContainer.innerHTML = marked.parse(result.analysis);
                hljs.highlightAll();
                chatInput.disabled = false; sendButton.disabled = false;
                appendMessage("The analysis is complete. You can now ask me specific questions about the document.", 'bot');
            } catch (error) {
                 statusDiv.textContent = `üî• Error: ${error.message}`;
                 analysisContainer.innerHTML = `<p style="color: red; text-align: center;">Analysis failed: ${error.message}</p>`;
            } finally { uploadButton.disabled = false; }
        });
        chatForm.addEventListener('submit', async e => {
            e.preventDefault();
            const question = chatInput.value.trim();
            if (!question) return;
            appendMessage(question, 'user');
            chatInput.value = ''; chatInput.disabled = true; sendButton.disabled = true;
            const botMessageContainer = appendMessage('', 'bot');
            const botContentDiv = botMessageContainer.querySelector('.message-content');
            let fullResponse = '';
            try {
                const response = await fetch('/chat', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ question: question }) });
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                while (true) {
                    const { value, done } = await reader.read();
                    if (done) break;
                    fullResponse += decoder.decode(value, { stream: true });
                    botContentDiv.innerHTML = marked.parse(fullResponse);
                    chatContainer.scrollTop = chatContainer.scrollHeight;
                }
                hljs.highlightAll();
            } catch (error) { botContentDiv.innerHTML = 'Sorry, an error occurred while getting the answer. ' + error.message;
            } finally { chatInput.disabled = false; sendButton.disabled = false; chatInput.focus(); }
        });
        function appendMessage(text, type) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${type}`;
            const avatar = `<div class="avatar">${type === 'user' ? 'You' : ''}</div>`;
            const content = `<div class="message-content">${type === 'bot' && text === '' ? '<span class="blinking-cursor">...</span>' : marked.parse(text)}</div>`;
            messageDiv.innerHTML = type === 'user' ? content + avatar : avatar + content;
            chatContainer.appendChild(messageDiv);
            chatContainer.scrollTop = chatContainer.scrollHeight;
            return messageDiv;
        }
    </script>
</body>
</html>